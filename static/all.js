function loadSound(e,t,i,n){var s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onload=function(){t.decodeAudioData(s.response,function(e){i&&i(e)},function(){n&&n()})},s.send()}function playSound(e,t){var i=e.createBufferSource();i.buffer=t,i.connect(e.destination),i.noteOn(0)}function initSound(e){var t={play:function(){},setVolume:function(){}};return loadSound(e,audioContext,function(e){t.play=function(){playSound(audioContext,e)}}),t}window.audio={setVolume:function(e){audio.volume=e;for(var t in audio)audio[t].setVolume&&audio[t].setVolume(audio.volume)},decreaseVolume:function(){audio.volume>0&&(audio.volume-=10),audio.setVolume(audio.volume)},increaseVolume:function(){100>audio.volume&&(audio.volume+=10),audio.setVolume(audio.volume)},mute:function(){audio.volume=0,audio.setVolume(audio.volume)},iOS:function(){return navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i)}};var audioContext=new webkitAudioContext;audio.explosionAudio=initSound("resources/audio/effects/explosion.mp3"),audio.appearAudio=initSound("resources/audio/effects/appear.mp3"),audio.changeColorAudio=initSound("resources/audio/effects/changecolor.mp3"),audio.laserAudio=initSound("resources/audio/effects/laser.mp3");var helpers={rotate:function(e,t,i){i=i*Math.PI/180;var n=e.x-t.x,s=e.y-t.y,o=Math.atan2(s,n),r=Math.sqrt(n*n+s*s),h=o+i,a=Math.cos(h)*r,l=Math.sin(h)*r;return{x:a*1.4+t.x,y:l+t.y}},distance:function(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))},ceilPoint:function(e){return{x:Math.ceil(e.x),y:Math.ceil(e.y)}},apply:function(e,t){if(e&&t)for(var i in e)t[i]=e[i];return t},rectInRect:function(e,t,i,n){if(e&&t&&i&&n){var s={x:t.x+e.x,y:t.y+e.y},o={x:t.x+t.w+e.x,y:t.y+e.y},r={x:t.x+e.x,y:t.y+t.h+e.y},h={x:t.x+t.w+e.x,y:t.y+t.h+e.y};return helpers.pointInRect(s,i,n)||helpers.pointInRect(o,i,n)||helpers.pointInRect(r,i,n)||helpers.pointInRect(h,i,n)}return!1},pointInRect:function(e,t,i){return!(i.x+t.x>e.x||e.x>i.x+t.x+i.w||i.y+t.y>e.y||e.y>i.y+t.y+i.h)}};if(typeof exports!="undefined"&&(exports.helpers=helpers),typeof require!="undefined")var helpers=require("./helpers").helpers,sys=require("sys");var entity=function(){};if(entity.prototype.render=function(){},entity.prototype.update=function(){},entity.prototype.collidesWith=function(e){return helpers.rectInRect(this.position,this.collisionRect,e.position,e.collisionRect)},typeof exports!="undefined"&&(exports.entity=entity),typeof require!="undefined")var helpers=require("./helpers").helpers,entity=require("./entity").entity;var explosion=function(e){helpers.apply(e,this),this.color=this.color||"#FFF",this.position=this.position||{x:0,y:0},this.duration=0,this.modelIndex=6,this.subEntities=[];for(var t=0;4>t;t++)this.subEntities.push({modelIndex:6,color:this.color,position:this.position,direction:0});this.audioDone=!1,this.rect={x:-5,y:-5,w:10,h:10}};if(explosion.prototype=new entity,explosion.prototype.render=function(){this.renderExplosion(this.duration,!this.audioDone),this.audioDone=!0},explosion.prototype.renderExplosion=function(e,t){if(t&&audio.explosionAudio.play(),e%2){var i={x:0-4*e,y:0};this.classicModel=[];for(var n=0;4>n;n++){var s=helpers.rotate(i,{x:0,y:0},n*90);this.classicModel.push({x:-5+s.x,y:-5+s.y,w:10,h:10}),this.subEntities[n].position={x:this.position.x+s.x,y:this.position.y+s.y}}this.classicModel.push(this.rect)}},explosion.prototype.update=function(){if(this.duration++,this.duration>10){this.finished=!0;for(var e=0;4>e;e++)this.subEntities[e].finished=!0}},explosion.prototype.getRemoteData=function(){var e=null;return this.remoteDataSend||(e="4,"+Math.ceil(this.position.x)+","+Math.ceil(this.position.y)+","+this.duration+","+(this.audioDone?"1":"0")+","+(this.finished?"1":"0"),this.audioDone=!0,this.remoteDataSend=!0),e},explosion.prototype.renderRemoteData=function(e,t){return this.classicModel=e[t+3]==="1"?this.rectsRight:this.rectsLeft,this.position={x:parseFloat(e[t+1]),y:parseFloat(e[t+2])},this.renderExplosion(parseFloat(e[t+3]),e[t+5]==="4"),this.finished=e[t+5]==="1",t+6},typeof exports!="undefined"&&(exports.explosion=explosion),typeof require!="undefined"){var helpers=require("./helpers").helpers,entity=require("./entity").entity,explosion=require("./explosion").explosion,colors,sys=require("sys");for(var s in colors)sys.puts(s);var laserbeam=require("./laserbeam").laserbeam,engine=require("./engine").engine;require("./ai/heuristic.js"),require("./ai/prioritizing.js")}var ship=function(e){helpers.apply(e,this),this.type=this.type||"player",this.laserState=300,this.direction=this.direction||1,this.colors=colors?colors:require("./rules").colors,this.color=this.colors[this.colorIndex]||this.color||"#FFF",this.speed=3,this.colorLoop=0,this.invulerability=1e3,this.audioDone=!1,this.name=this.name||"ship",this.position=this.position||{x:0,y:0},this.gunOffset={x:40,y:0},this.collisionRect={x:-15,y:-10,w:30,h:20},this.modelIndex=0,this.rectsRight=[{x:-20,y:-15,w:20,h:10},{x:-10,y:-5,w:30,h:10},{x:-20,y:5,w:20,h:10}],this.rectsLeft=[{x:0,y:-15,w:20,h:10},{x:-20,y:-5,w:30,h:10},{x:0,y:5,w:20,h:10}]};if(ship.prototype=new entity,ship.prototype.getTimeDelta=function(){this.lastTimeCalled||(this.lastTimeCalled=time);var e=time-this.lastTimeCalled;return this.lastTimeCalled=time,e},ship.prototype.update=function(){var e=this.getTimeDelta();if(this.engine.mode!=="client"){if(this.invulerability&&(this.invulerability-=e,0>this.invulerability&&(this.invulerability=0)),this.collisions&&this.collisions.length)for(var t=0;this.collisions.length>t;t++){var i=this.collisions[t];if(i.owner!=this&&(!this.invulerability||i!=this.spawnStar)){i.parent&&i.type==="star"&&i.color!==this.color&&(i.finished=!0),this.finished=!0;break}}this.updateControllerState()}this.move(e),this.engine.mode!=="client"&&this.updateLaser(e)},ship.prototype.onRemove=function(){this.engine.mode!=="server"&&this.engine.add(new explosion({position:this.position}))},ship.prototype.move=function(e){var t=this.position;this.position=this.calculateMovement(this.position,this.mousePosition,10,e),this.position.x>t.x?this.direction=1:t.x>this.position.x&&(this.direction=-1),this.classicModel=this.direction===1?this.rectsRight:this.rectsLeft},ship.prototype.updateLaser=function(e){this.shoot&&this.laserState>=300?(this.laserState=0,this.gunOffset.x=this.direction===1?40:-40,this.engine.add(new laserbeam({position:{x:this.position.x+this.gunOffset.x,y:this.position.y+this.gunOffset.y},direction:this.direction,owner:this}))):this.laserState=300>this.laserState?this.laserState+e:300},ship.prototype.updateControllerState=function(){if(this.shoot=!1,this.type!="computer")this.engine.mode=="standalone"||this.name=="Player 1"&&this.engine.player1?(this.shoot=this.engine.buttonDown,this.mousePosition=this.correctMousePosition(this.engine.mousePosition,this.engine.absoluteController)):this.name=="Player 2"&&this.engine.player2&&(this.shoot=this.engine.buttonDown2,this.mousePosition=this.engine.mousePosition2);else if(this.type=="computer"){var e;e=this.name==="Player 1"?engine.ai[engine.player1ai].call(this):engine.ai[engine.player2ai].call(this),this.mousePosition=e.mousePosition,this.shoot=e.shoot}},ship.prototype.correctMousePosition=function(e,t){return t?e:{x:e.x+this.position.x,y:e.y+this.position.y}},ship.prototype.calculateMovement=function(e,t,i,n){var s=t.x-e.x,o=t.y-e.y,r=helpers.distance(e,t),h=.25,a=i*(n/35);r>a&&(h=a/r);var l=this.position.x+s*h,u=this.position.y+o*h;return 0>l&&(l=0),l>this.engine.width&&(l=this.engine.width),0>u&&(u=0),u>this.engine.height&&(u=this.engine.height),{x:l,y:u}},ship.prototype.render=function(){if(!this.audioDone){this.audioDone=!0;try{audio&&audio.appearAudio.play()}catch(e){}}},ship.prototype.getRemoteData=function(){var e=null;if(this.mousePosition){var t=Math.ceil(this.mousePosition.x),i=Math.ceil(this.mousePosition.y);this.previousMousePosition&&t===this.previousMousePosition.x&&i===this.previousMousePosition.y||(this.previousMousePosition={x:t,y:i},e="0,"+Math.ceil(this.position.x)+","+Math.ceil(this.position.y)+","+this.colorIndex+","+t+","+i)}return e},ship.prototype.renderRemoteData=function(e,t){return this.classicModel=this.direction===1?this.rectsRight:this.rectsLeft,this.position={x:parseInt(e[t+1]),y:parseInt(e[t+2])},this.mousePosition={x:parseInt(e[t+4]),y:parseInt(e[t+5])},this.colorIndex=parseInt(e[t+3]),this.color=this.colors[this.colorIndex],t+6},typeof exports!="undefined"&&(exports.ship=ship),typeof require!="undefined"){var helpers=require("./helpers").helpers,entity=require("./entity").entity,colors,laserbeam=require("./laserbeam").laserbeam,explosion=require("./explosion").explosion,engine=require("./engine").engine;require("./ai/ufo.js")}var ufo=function(e){helpers.apply(e,this),this.laserState=10,this.direction=this.direction||1,this.audioDone=!1,this.colors=colors?colors:require("./rules").colors,this.color=this.colors[this.colorIndex]||this.color||"#FFF",this.speed=3,this.invulerability=20,this.nextFrame=!1,this.name=this.name||"ufo",this.position=this.position||{x:0,y:0},this.gunOffset={x:40,y:0},this.collisionRect={x:-20,y:-15,w:40,h:30},this.modelIndex=4,this.ufoFrame=0,this.ufoFrames=[[{x:-10,y:-15,w:20,h:10},{x:-10,y:-5,w:30,h:10},{x:-10,y:5,w:20,h:10}],[{x:-10,y:-15,w:20,h:10},{x:-20,y:-5,w:10,h:10},{x:0,y:-5,w:20,h:10},{x:-10,y:5,w:20,h:10}],[{x:-10,y:-15,w:20,h:10},{x:-20,y:-5,w:20,h:10},{x:10,y:-5,w:10,h:10},{x:-10,y:5,w:20,h:10}],[{x:-10,y:-15,w:20,h:10},{x:-20,y:-5,w:30,h:10},{x:-10,y:5,w:20,h:10}],[{x:-10,y:-15,w:20,h:10},{x:-20,y:-5,w:40,h:10},{x:-10,y:5,w:20,h:10}]]};if(ufo.prototype=new entity,ufo.prototype.render=function(){if(!this.audioDone){this.audioDone=!0;try{audio&&audio.appearAudio.play()}catch(e){}}},ufo.prototype.update=function(e){if(this.engine.mode!=="client"){this.handleCollisions();var t=engine.ai[engine.ufoai].call(this);this.mousePosition=t.mousePosition,this.shoot=t.shoot}var i=this.getTimeDelta();this.position=this.calculateMovement(this.position,this.mousePosition,10,i),this.engine.mode!=="client"&&this.handleLaser(e),this.handleAnimation(e)},ufo.prototype.getTimeDelta=function(){this.lastTimeCalled||(this.lastTimeCalled=time);var e=time-this.lastTimeCalled;return this.lastTimeCalled=time,e},ufo.prototype.calculateMovement=function(e,t,i,n){var s=e;if(t){var o=t.x-e.x,r=t.y-e.y,h=helpers.distance(e,t),a=.25,l=i*(n/40);h>l&&(a=l/h),s={x:this.position.x+o*a,y:this.position.y+r*a}}return s},ufo.prototype.handleCollisions=function(){if(this.invulerability&&this.invulerability--,this.collisions&&this.collisions.length)for(var e=0;this.collisions.length>e;e++)if(this.collisions[e].owner!=this&&!this.invulerability){this.engine.gameState.gameOver||this.finished||(this.collisions[e].owner==this.engine.gameState.player1Ship&&this.engine.gameState.player1Score++,this.collisions[e].owner==this.engine.gameState.player2Ship&&this.engine.gameState.player2Score++),this.finished=!0;break}},ufo.prototype.onRemove=function(){this.engine.mode!=="server"&&this.engine.add(new explosion({position:this.position}))},ufo.prototype.handleLaser=function(){this.shoot&&this.laserState==10?(this.laserState=-20,this.gunOffset.x=this.direction===1?40:-40,this.engine.add(new laserbeam({position:{x:this.position.x+this.gunOffset.x,y:this.position.y+this.gunOffset.y},direction:this.direction,owner:this}))):this.laserState!=10&&(this.laserState=this.laserState+2)},ufo.prototype.handleAnimation=function(e){this.direction=1,this.mousePosition&&this.mousePosition.x>this.position.x&&(this.direction=-1),this.lastTimeFrameChanged||(this.lastTimeFrameChanged=e);var t=e-this.lastTimeFrameChanged;t>80&&(this.lastTimeFrameChanged=e,this.classicModel=this.ufoFrames[this.ufoFrame],this.ufoFrame+=this.direction,this.ufoFrames.length>this.ufoFrame||(this.ufoFrame=0),0>this.ufoFrame&&(this.ufoFrame=this.ufoFrames.length-1)),this.ufoFrame===0?(this.modelIndex=2,this.direction=1):this.ufoFrame===1?(this.modelIndex=3,this.direction=1):this.ufoFrame===2?(this.modelIndex=4,this.direction=1):this.ufoFrame===3?(this.modelIndex=4,this.direction=-1):this.ufoFrame===4&&(this.modelIndex=3,this.direction=-1)},ufo.prototype.getRemoteData=function(){var e=null;if(this.mousePosition){var t=Math.ceil(this.mousePosition.x),i=Math.ceil(this.mousePosition.y);this.previousMousePosition&&t===this.previousMousePosition.x&&i===this.previousMousePosition.y||(this.previousMousePosition={x:t,y:i},e="3,"+Math.ceil(this.position.x)+","+Math.ceil(this.position.y)+","+this.colorIndex+","+t+","+i)}return e},ufo.prototype.renderRemoteData=function(e,t){return this.position={x:parseFloat(e[t+1]),y:parseFloat(e[t+2])},this.colorIndex=parseInt(e[t+3]),this.color=this.colors[this.colorIndex],this.mousePosition={x:parseInt(e[t+4]),y:parseInt(e[t+5])},t+6},typeof exports!="undefined"&&(exports.ufo=ufo),typeof require!="undefined")var helpers=require("./helpers").helpers,entity=require("./entity").entity,colors;var star=function(e){helpers.apply(e,this),this.type="star",this.colors=colors?colors:require("./rules").colors,this.color=this.colors[this.colorIndex]||this.color||"#FFF",this.previousColor=this.color,this.position=this.position||{x:0,y:0},this.angle=this.angle||0,this.collisionRect={x:-15,y:-15,w:30,h:30},this.modelIndex=1,this.bottomOffset=30,this.rects=[{x:-10,y:-20,w:20,h:10},{x:-20,y:-10,w:40,h:10},{x:-20,y:0,w:40,h:10},{x:-10,y:10,w:20,h:10}]};if(star.prototype=new entity,star.prototype.render=function(){this.makeSound&&(audio.changeColorAudio.play(),this.makeSound=!1),this.classicModel=this.rects},star.prototype.update=function(e){if(this.engine.mode!=="client"){if(!this.initialized){if(!this.parent)for(var t=0;4>t;t++)this.engine.add(new star({name:this.name+"."+t,type:"star",starId:this.starId+(t+1),colorIndex:this.colorIndex,direction:-1,position:{x:this.position.x-110,y:this.position.y},angle:90*t,parent:this,bottomOffset:this.bottomOffset}));this.initialized=!0}if(this.collisions&&this.collisions.length)for(var t=0;this.collisions.length>t;t++)this.collisions[0].name=="laserbeam"&&(this.colorIndex++,this.colorIndex==this.colors.length&&(this.colorIndex=0),this.color=this.colors[this.colorIndex],this.makeSound=!0)}this.parentCenter||(this.parentCenter={x:this.engine.width/2,y:this.engine.height/2-this.bottomOffset},this.parentOriginalPosition={x:this.engine.width/2,y:this.engine.height*.25-this.bottomOffset}),this.position=this.starId===0||this.starId===5?this.calculateParentPosition(this.starId,e):this.calculateSubPosition(this.starId,e)},star.parentSpeed=.3,star.subSpeed=.5,star.prototype.calculateParentPosition=function(e,t){var i=-(star.parentSpeed*(t/40));return e===5&&(i+=180),helpers.rotate(this.parentOriginalPosition,this.parentCenter,i)},star.prototype.calculateSubPosition=function(e,t){var i=-(star.subSpeed*(t/40));i+=90*(e%5-1);var n=this.calculateParentPosition(5>e?0:5,t),s={x:n.x-100,y:n.y};return helpers.rotate(s,n,i)},star.prototype.getRemoteData=function(){var e=null;return this.remoteDataSend&&this.color===this.previousColor||(e="2,"+this.colorIndex+","+(this.makeSound?"1":"0")+","+this.starId,this.makeSound=!1,this.remoteDataSend=!0,this.previousColor=this.color),e},star.prototype.renderRemoteData=function(e,t){return parseFloat(e[t+2])&&audio.changeColorAudio.play(),this.classicModel=this.rects,this.colorIndex=parseInt(e[t+1]),this.color=this.colors[this.colorIndex],this.starId=parseInt(e[t+3]),t+4},typeof exports!="undefined"&&(exports.star=star),typeof require!="undefined")var helpers=require("./helpers").helpers,entity=require("./entity").entity;var laserbeam=function(e){helpers.apply(e,this),this.name="laserbeam",this.direction=this.direction||1,this.color="#FFF",this.position=this.position||{x:0,y:0},this.modelIndex=5,this.rects=[{x:-20,y:-5,w:40,h:10}],this.classicModel=this.rects,this.collisionRect=this.rects[0],this.audioDone=!1};laserbeam.prototype=new entity,laserbeam.prototype.render=function(){audio&&!this.audioDone&&(this.audioDone=!0,audio.laserAudio.play())},laserbeam.prototype.update=function(e){if(this.engine.mode!=="client"&&(this.finished=-40>this.position.x||this.position.x>this.engine.width+20,this.collisions&&this.collisions.length))for(var t=0;this.collisions.length>t;t++)if(this.collisions[t]!=this.owner)return this.finished=!0,void 0;this.startTime||(this.startTime=e,this.startPosition=this.position),this.position.x=this.startPosition.x+this.direction*(e-this.startTime)/6},laserbeam.prototype.getRemoteData=function(){var e=null;return this.remoteDataSend||this.finished||(e="1,"+Math.ceil(this.position.x)+","+Math.ceil(this.position.y)+","+this.direction,this.audioDone=!0,this.remoteDataSend=!0),e},laserbeam.prototype.renderRemoteData=function(e,t){return this.position={x:parseInt(e[t+1]),y:parseInt(e[t+2])},this.direction=parseInt(e[t+3]),t+4},typeof exports!="undefined"&&(exports.laserbeam=laserbeam);var scorebar=function(e){helpers.apply(e,this),this.name="scorebar",(this.engine.mode=="standalone"||this.engine.mode=="client")&&window.THREE&&(this.geometry=new THREE.CubeGeometry(1,125/12,(this.engine.width-30)*2.5/12)),this.position={x:this.engine.width/2,y:this.engine.height-36,z:-40},this.classicModel=[{x:-(this.engine.width-30)/2,y:-25,w:this.engine.width-30,h:50}],this.direction=1,this.finished=!1,this.modelIndex=-1,this.color="#00F"};if(scorebar.prototype=new entity,scorebar.prototype.addScoreBarItem=function(e,t,i){this.texts.push({font:"50px CBM64",color:t,text:e,position:{x:i,y:this.engine.height-15}})},scorebar.prototype.setScore=function(e,t){this.texts||(this.texts=[],this.addScoreBarItem("0","#F00",20),this.addScoreBarItem(" 0","#FF0",this.engine.width-95),this.addScoreBarItem("LASER WAR","#FFF",230)),this.texts[0].text=e,this.texts[1].text=(10>t?" ":"")+t},typeof require!="undefined")var entity=require("./entity").entity,helpers=require("./helpers").helpers,ship=require("./ship").ship,star=require("./star").star,ufo=require("./ufo").ufo,engine=require("./engine").engine;var colors=["#F00","#0F0","#0FF","#FF0","#F0F","#00F","#AAA"],mainMenu={"    SINGLE PLAYER":{onMousePlaneUp:function(e){e.engine.rules.startSinglePlayerGame()}},"    MULTI  PLAYER":{onMousePlaneUp:function(e){e.engine.rules.startMultiPlayerGame()}},"":{},"    SETTINGS":{onMousePlaneUp:function(e){e.engine.rules.menu.setItems(settingsMenu)}}},settingsMenu={AUDIO:{onMousePlaneUp:function(e){engine.effectsVolume=engine.getItem("effectsVolume","0")==="0"?10:0,engine.setItem("effectsVolume",engine.effectsVolume),window.audio.setVolume(engine.effectsVolume),e.engine.rules.menu.setItems(settingsMenu)},getText:function(){var e;return e=engine.getItem("effectsVolume","0")==="0"?"      AUDIO: OFF":"      AUDIO:  ON"}},VIDEO:{onMousePlaneUp:function(e){if(engine.getItem("renderer","classic")==="classic"){var t=function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(e){return!1}}();t?engine.renderer="webgl":alert("Sorry, 3D is not support by your bowser.")}else engine.renderer="classic";engine.setItem("renderer",engine.renderer),e.engine.rules.menu.setItems(settingsMenu)},getText:function(){var e;return e=engine.getItem("renderer","classic")==="classic"?"      VIDEO:  2D":"      VIDEO:  3D"}},"":{},"      MAIN MENU":{onMousePlaneUp:function(e){e.engine.rules.menu.setItems(mainMenu)}}},gameOverMenu={"      GAME OVER":{},"":{},"      PLAY AGAIN":{onMousePlaneUp:function(e){e.engine.rules[e.engine.rules.currentGameType]()}},"      MAIN MENU":{onMousePlaneUp:function(e){e.engine.rules.menu.setItems(mainMenu)}}},introMenu={"  LASER WAR":{},"":{},"  RIGHT CLICK":{},"  FOR MENU":{}};typeof exports!="undefined"&&(exports.colors=colors);var rules=function(e){if(helpers.apply(e,this),this.initialized=!1,this.engineId=0,this.name="rules",this.barHeight=30,this.engine.mode!=="server"){var t=this,i=function(){t.keyboardHandler()};document.addEventListener?document.addEventListener("keyup",i,!1):document.attachEvent?document.attachEvent("onkeyup",i):document.onkeydown||document.onkeyup||(document.onkeyup=i)}};if(rules.prototype=new entity,rules.prototype.initialize=function(){this.previousRightButtonDown=!1,this.initialized=!0,this.engine.canvasColor="#000",this.engine.gameState={player1Ship:null,player2Ship:null,player3Ship:null,player4Ship:null,player1Score:0,player2Score:0,gameOver:!1},this.engine.mode!=="server"&&(this.scoreBar=new scorebar({engine:this.engine}),this.engine.add(this.scoreBar),this.menu||(this.menu=new menu({engine:this.engine,mainMenu:mainMenu}),this.engine.add(this.menu),this.menu.setItems(mainMenu))),this.engine.mode!=="client"&&(this.engine.add(this.engine.gameState.player1Ship=new ship({name:"Player 1",type:this.engine.mode=="standalone"?this.engine.playerCount===0?"computer":"player":this.engine.player1?"player":"computer",direction:1,colorIndex:0,position:{x:10,y:10}})),this.engine.add(this.engine.gameState.player2Ship=new ship({name:"Player 2",type:this.engine.mode=="standalone"?this.engine.playerCount!==2?"computer":"player":this.engine.player2?"player":"computer",colorIndex:3,direction:-1,position:{x:this.engine.width-40,y:this.engine.height-50-this.barHeight}})),this.engine.add(new star({name:"Star 1",type:"star",colorIndex:0,direction:-1,starId:0,position:{x:this.engine.width/2,y:this.engine.height*.25-this.barHeight},bottomOffset:this.barHeight})),this.engine.add(new star({name:"Star 2",type:"star",colorIndex:3,direction:-1,starId:5,position:{x:this.engine.width/2,y:this.engine.height*.75-this.barHeight},bottomOffset:this.barHeight})))},rules.prototype.getStar=function(e,t,i){for(var n=0;this.engine.entities.length>n;n++)if(this.engine.entities[n].type=="star"&&this.engine.entities[n].colorIndex==e.colorIndex&&(!t||this.engine.entities[n].collidesWith({position:i,collisionRect:{x:-20,y:-20,w:40,h:40}})))return this.engine.entities[n];return null},rules.prototype.spawnPlayerShip=function(e,t,i,n,s,o,r){var h=e;if(e.finished&&(t&&n=="player"||n=="computer")){var a=this.getStar(e,n=="player",r);a&&(h=new ship({name:i,type:n,direction:s,colorIndex:o,position:r,spawnStar:a}),this.engine.add(h))}return h},rules.prototype.parseControlString=function(e,t,i){var n=e.split(",");this.engine[i]={x:parseFloat(n[1]),y:parseFloat(n[2])},this.engine[t]=n[3]==1},rules.prototype.ensureUserRespawn=function(e,t,i,n,s,o){var r=e;if(e&&e.finished){var h={x:t.x,y:t.y},a=null;(e.type==="computer"||this.engine.touchController.touchable)&&(a=this.getStar(e,!1),a&&(h=helpers.ceilPoint({x:a.position.x,y:a.position.y}))),(e.type==="player"||e.type==="computer"&&a)&&(r=this.spawnPlayerShip(e,i,n,e.type,s,o,h))}return r},rules.prototype.update=function(){if(this.initialized||this.initialize(),this.engine.mode!=="server"){if(this.engine.gameState.gameOver!==this.previousGameOverState)if(this.previousGameOverState=this.engine.gameState.gameOver,this.engine.gameState.gameOver&&(this.engine.playerCount>0||this.engine.mode==="client"))this.showGameOver();else{if(this.engine.gameState.gameOver&&this.engine.playerCount===0)return this.menu.finished?this.engine.reset():this.engine.reset(this.menu),void 0;this.engine.mode==="client"&&this.hideMenu()}this.scoreBar.setScore(this.engine.gameState.player1Score,this.engine.gameState.player2Score),this.previousRightButtonDown!==this.engine.rightButtonDown&&(this.engine.rightButtonDown===!1&&this.toggleMenu(),this.previousRightButtonDown=this.engine.rightButtonDown)}if(this.engine.mode!=="client"){var e=this.engine.playerCount===0?engine.maxAiScore:engine.maxScore;this.engine.gameState.gameOver=this.engine.gameState.player1Score===e||this.engine.gameState.player2Score===e,this.engine.gameState.player1Ship=this.ensureUserRespawn(this.engine.gameState.player1Ship,this.engine.mousePosition,this.engine.buttonDown,"Player 1",1,0),this.engine.gameState.player2Ship=this.ensureUserRespawn(this.engine.gameState.player2Ship,this.engine.mousePosition2,this.engine.buttonDown2,"Player 2",-1,3),(!this.engine.gameState.player3||this.engine.gameState.player3&&this.engine.gameState.player3.finished)&&6==Math.floor(Math.random()*200)&&this.engine.add(this.engine.gameState.player3=new ufo({name:"Player 3",type:"computer",colorIndex:2,direction:-1,position:{x:this.engine.width-40,y:10}})),(!this.engine.gameState.player4||this.engine.gameState.player4&&this.engine.gameState.player4.finished)&&6==Math.floor(Math.random()*200)&&this.engine.add(this.engine.gameState.player4=new ufo({name:"Player 4",type:"computer",colorIndex:4,direction:-1,position:{x:10,y:this.engine.height-50-this.barHeight}}))}},rules.prototype.getRemoteData=function(){var e=null,t="5,"+this.engine.gameState.player1Score+","+this.engine.gameState.player2Score+","+(this.engine.gameState.gameOver?1:0);return t!==this.previousMessage&&(e=this.previousMessage=t),e},rules.prototype.renderRemoteData=function(e,t){return this.engine.gameState.player1Score=e[t+1],this.engine.gameState.player2Score=e[t+2],this.engine.gameState.gameOver=e[t+3]==="1",t+4},rules.prototype.startSinglePlayerGame=function(){this.currentGameType="startSinglePlayerGame",this.engine.mode="standalone",this.engine.playerCount=1,this.engine.reset(),this.hideMenu()},rules.prototype.startMultiPlayerGame=function(){this.currentGameType="startMultiPlayerGame",this.engine.socket?(this.engine.socket.emit("start game","foo","bar"),this.engine.mode="client",this.hideMenu()):alert("Multiplayer is currently not available.")},rules.prototype.startServerGame=function(){this.engine.mode="server",this.engine.player1&&this.engine.player1.emit("reset",0),this.engine.player2&&this.engine.player2.emit("reset",0),this.engine.reset()},rules.prototype.startZeroPlayerGame=function(){this.currentGameType="startZeroPlayerGame",this.engine.mode="standalone",this.engine.playerCount=0,this.engine.reset(),this.hideMenu()},rules.prototype.showGameOver=function(){this.showMenu(gameOverMenu)},rules.prototype.showMenu=function(e){return this.menu.show(e)},rules.prototype.toggleMenu=function(){return this.menu.toggle()},rules.prototype.hideMenu=function(){return this.menu.hide()},rules.prototype.toggleSettings=function(){DAT.GUI.toggleHide()},rules.prototype.keyboardHandler=function(e){e=e||window.event;var t=e.keyCode||e.which;t==49&&this.startSinglePlayerGame(),t==50&&this.startMultiPlayerGame(),t==51&&audio.decreaseVolume(),t==52&&audio.increaseVolume(),t==53&&audio.mute(),t==54&&this.startZeroPlayerGame(),t===77&&(this.menu.currentItems===introMenu?this.menu.gotoRoot():this.toggleMenu())},typeof exports!="undefined"&&(exports.rules=rules),typeof require!="undefined")var helpers=require("./helpers").helpers;var engine=function(e){if(helpers.apply({debug:!1,width:800,height:600,pageColor:"#555",canvasColor:"#000",playerCount:0},this),helpers.apply(e,this),(this.mode=="standalone"||this.mode=="client")&&(document.onselectstart=function(){return!1},document.body.style.background=this.pageColor,engine.settings.initialize()),this.buttonDown=!1,this.mousePosition={x:0,y:0},this.buttonDown2=!1,this.mousePosition2={x:0,y:0},this.entities=[],this.remoteData=[],this.previousControllerMessageTime=0,this.previousGameStateMessageTime=0,this.remoteDataString=[],this.finishedEntities=[],this.startTime=(new Date).getTime(),this.rulesType&&(this.rules=new this.rulesType({engine:this}),this.add(this.rules)),this.mode==="server")this.serverUpdateLoop();else{window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}()),this.initializeControllers();var t=this;this.socket&&(this.socket.on("game state",function(e){t.remoteDataString.push(e)}),this.socket.on("reset",function(){t.reset()})),this.animate(),document.body.oncontextmenu=function(){return!1}}};engine.prototype.initializeControllers=function(){this.controllers=[],this.touchController=new touchController({engine:this}),this.controllers.push(this.touchController),this.mouseController=new mouseController({engine:this}),this.controllers.push(this.mouseController)},engine.prototype.serverUpdateLoop=function(){var e=this;setTimeout(function(){e.serverUpdateLoop()},20),this.update()},engine.prototype.animate=function(){var e=this;requestAnimationFrame(function(){e.animate()}),this.update(),engine.rendering[engine.renderer]||(engine.renderer="classic"),engine.previousRenderer&&engine.previousRenderer!==engine.renderer&&engine.rendering[engine.previousRenderer].call(this,!0),engine.rendering[engine.renderer].call(this),engine.previousRenderer=engine.renderer},engine.prototype.add=function(e){this.entities.length===0&&(this.entityIdCounter=0),e.engineId||this.mode!=="server"||(e.engineId=this.entityIdCounter,this.entityIdCounter++),this.entities.push(e),e.engine=this},engine.prototype.contains=function(e){for(var t=!1,i=0,n=this.entities.length;n>i;i++)if(this.entities[i]===e){t=!0;break}return t},engine.prototype.calculateCollisions=function(){for(var e=0,t=this.entities.length;t>e;e++){var i=this.entities[e];i.collisions=[];for(var n=0;t>n;n++){var s=this.entities[n];i!=s&&i.collidesWith(s)&&(i.collisions.push(s),s.collisions||(s.collisions=[]),s.collisions.push(i))}}},engine.prototype.reset=function(e){this.entities=e?[e]:[],this.startTime=(new Date).getTime(),this.previousControllerMessageTime=0,this.previousGameStateMessageTime=0,this.remoteData=[],this.remoteDataString=[],this.add(this.rules),this.rules.initialized=!1},engine.prototype.update=function(){time=(new Date).getTime()-this.startTime,this.mode!=="client"?this.calculateCollisions():this.mode==="client"&&(this.sendControllerStateToServer(time),this.processRemoteData()),this.updateEntities(time)},engine.prototype.sendControllerStateToServer=function(e){this.socket&&(50>e-this.previousControllerMessageTime||(this.previousControllerMessageTime=e,this.controllerMessage=this.mousePosition.x+","+this.mousePosition.y+","+(this.buttonDown?1:0),this.controllerMessage!==this.previousControllerMessage&&(this.previousControllerMessage=this.controllerMessage,this.socket.emit("controller state",this.controllerMessage))))},engine.prototype.updateEntities=function(e){for(var t=0,i=this.entities.length;i>t;t++){var n=this.entities[t];n&&n.update&&n.update(e)}this.removeFinishedEntities(),this.sendGameStateToClient(e)},engine.prototype.removeFinishedEntities=function(){var e=this.entities;this.entities=[],this.finishedEntities=this.finishedEntities||[];for(var t=0,i=e.length;i>t;t++){var n=e[t];n&&!n.finished?this.entities.push(n):n&&n.finished&&(n.onRemove&&n.onRemove(),this.mode==="server"&&this.finishedEntities.push(n))}},engine.prototype.sendGameStateToClient=function(e){var t=this.prepareRemoteData(e);t!==""&&(this.player1&&this.player1.emit("game state",t),this.player2&&this.player2.emit("game state",t))},engine.prototype.prepareRemoteData=function(e){var t="";return this.mode!=="server"||50>e-this.previousGameStateMessageTime&&e>=this.previousGameStateMessageTime||(this.previousGameStateMessageTime=e,t=this.appendRemoteData(this.entities,t),t=this.appendRemoteData(this.finishedEntities,t),this.finishedEntities=[]),t&&(t=e+","+t),t},engine.prototype.appendRemoteData=function(e,t){for(var i=0,n=e.length;n>i;i++){var s=e[i];if(s&&s.getRemoteData)if(s.finished)t=t?t+",":"",t=t+s.engineId+",-1";else{var o=s.getRemoteData();o&&(t=t?t+",":"",t=t+s.engineId+","+o)}}return t},engine.prototype.getEntityById=function(e){for(var t=null,i=0,n=this.entities.length;n>i;i++)if(e===this.entities[i].engineId){t=this.entities[i];break}return t},engine.prototype.processRemoteData=function(){var e=this.remoteDataString.shift();while(e){var t=e.split(","),i=0;this.lastServerTimedate=t[0],i++;var n=t.length;while(n>i){var s=null,o=parseInt(t[i]);if(i++,s=this.getEntityById(o),s===null&&t[i]!=="-1"){var r=engine.remoteRenderer[t[i]];s=new r({engine:this,engineId:o}),this.add(s)}else s||t[i]!=="-1"?s&&t[i]==="-1"&&(i++,s.finished=!0):i++;s&&!s.finished&&(i=s.renderRemoteData(t,i))
}e=this.remoteDataString.shift()}},engine.setItem=function(e,t){typeof t=="object"&&(t=JSON.stringify(t)),localStorage.setItem(e,t)},engine.getItem=function(e,t){var i=null;return typeof localStorage!="undefined"&&(i=localStorage.getItem(e),i&&i[0]=="{"&&(i=JSON.parse(i))),i||t},engine.ai={},engine.player1ai=engine.getItem("player1ai","heuristic"),engine.player2ai=engine.getItem("player2ai","heuristic"),engine.ufoai=engine.getItem("player2ai","heuristic"),engine.rendering={},engine.renderer=engine.getItem("renderer","classic"),engine.effectsVolume=parseInt(engine.getItem("effectsVolume",10)),engine.musicVolume=parseInt(engine.getItem("musicVolume",40)),engine.maxScore=parseInt(engine.getItem("maxScore",10)),engine.maxAiScore=parseInt(engine.getItem("maxAiScore",10)),typeof exports!="undefined"?exports.engine=engine:(engine.remoteRenderer=[],engine.remoteRenderer.push(ship),engine.remoteRenderer.push(laserbeam),engine.remoteRenderer.push(star),engine.remoteRenderer.push(ufo),engine.remoteRenderer.push(explosion),engine.remoteRenderer.push(rules)),engine.settings={initialize:function(){try{var e=new DAT.GUI({height:223});DAT.GUI.toggleHide(),DAT.GUI.supressHotKeys=!0,e.add(engine,"player1ai").options("heuristic","prioritizing").onChange(function(e){engine.setItem("player1ai",e)}),e.add(engine,"player2ai").options("heuristic","prioritizing").onChange(function(e){engine.setItem("player2ai",e)}),e.add(engine,"renderer").options("classic","webgl").onChange(function(e){engine.setItem("renderer",e)}),e.add(engine,"effectsVolume",0,100,1).onChange(function(e){engine.setItem("effectsVolume",e),window.audio.setVolume(e)}),e.add(engine,"musicVolume",0,100,1).onChange(function(e){engine.setItem("musicVolume",e)}),e.add(engine,"maxScore",1,99,1).onChange(function(e){engine.setItem("maxScore",e)}),e.add(engine,"maxAiScore",1,99,1).onChange(function(e){engine.setItem("maxAiScore",e)})}catch(t){}}};var menu=function(e){helpers.apply({color:"#AAA",selectedColor:"#FFF",mousePlaneOffset:250,mousePlane:"z",topMost:!0},this),helpers.apply(e,this),this.setItems(this.mainMenu)};if(menu.prototype=new entity,menu.prototype.gotoRoot=function(){this.setItems(this.mainMenu)},menu.prototype.onmouseup=function(){this.ignoreNextButtonUp?this.ignoreNextButtonUp=!1:this.selected&&this.selected.onMousePlaneUp&&this.selected.onMousePlaneUp(this,this)},menu.prototype.setItems=function(e){this.engine.buttonDown&&(this.ignoreNextButtonUp=!0),this.currentItems=e,this.clear(),this.texts=[];var t=0;for(var i in e){var n=i;e[i].getText&&(n=e[i].getText(this));var s=helpers.apply(e[i],{font:"50px CBM64",color:this.color,engine:this.engine,text:n,position:{x:0,y:this.engine.height/3+t*60,z:this.mousePlaneOffset}});if(s.submenu){var o=this;s.onMousePlaneUp=function(e){o.setItems(e.submenu)}}this.texts.push(s),t++}},menu.prototype.show=function(e){this.finished&&(this.finished=!1,this.engine.contains(this)||this.engine.add(this),this.gotoRoot()),e&&this.setItems(e)},menu.prototype.toggle=function(){this.finished?(this.finished=!1,this.engine.contains(this)||this.engine.add(this),this.gotoRoot()):this.finished=!0},menu.prototype.hide=function(){this.finished=!0},menu.prototype.clear=function(){if(this.subEntities)for(var e=0,t=this.subEntities.length;t>e;e++)this.subEntities[e].finished=!0},menu.prototype.select=function(e){this.selected!=e&&(this.selected&&(this.selected.color=this.color),this.selected=e,this.selected&&(this.selected.color=this.selectedColor))},menu.prototype.update=function(){if(this.mousePosition&&this.texts){var e=Math.floor((this.mousePosition.y-this.engine.height/3)/60)+1;e>-1&&this.texts.length>e&&this.texts[e].onMousePlaneUp?(this.select(this.texts[e]),this.engine.touchController.touchable&&(this.onmouseup(this.texts[e],!0),this.ignoreNextButtonUp=!0)):this.select(null)}},menu.prototype.render=function(){},typeof require!="undefined")var helpers=require("./../helpers").helpers,engine=require("./../engine").engine;if(engine.ai.prioritizing=function(){var e=0,t=0;this.shoot=!1;var i=!1;this.responseDelay?this.responseDelay--:this.responseDelay=0,this.starShootDelay&&this.starShootDelay--;for(var n=0;this.engine.entities.length>n;n++)this.engine.entities[n].type=="star"&&this.engine.entities[n].colorIndex==this.colorIndex&&e++;for(var n=0,s=this.engine.entities.length;s>n;n++)if(i=!1,this.engine.entities[n]!=this&&this.engine.entities[n].owner!=this&&this.engine.entities[n].position){var o=0;this.engine.entities[n].type==="player"||this.engine.entities[n].type==="computer"?(o=30,i=!0):this.engine.entities[n].type=="star"&&this.engine.entities[n].colorIndex!=this.colorIndex?(o=10,e==0&&(o+=20),e==1&&(o+=10),this.starShootDelay||(i=!0,this.starShootDelay=10)):this.engine.entities[n].type=="ufo"&&(o=5,i=!0);var r=helpers.distance(this.position,this.engine.entities[n].position),h=50>r;if(h&&(o=100),o>t){t=o,this.responseDelay=1,this.mousePosition={x:this.engine.entities[n].position.x+110,y:this.engine.entities[n].position.y},h&&(this.mousePosition.x=(this.mousePosition.x-this.position.x)*-1e5,this.mousePosition.y=(this.mousePosition.y-this.position.y)*-1e5);var a=Math.abs(this.position.y-this.engine.entities[n].position.y);i&&30>a&&(this.shoot=i)}}return{mousePosition:this.mousePosition,shoot:this.shoot}},typeof require!="undefined")var helpers=require("./../helpers").helpers,engine=require("./../engine").engine;if(engine.ai.heuristic=function(){var e=this.position,t=1/0;this.nearestEntity=null;var i=1/0,n=null,s=null;this.evading=!1;for(var o=0,r=this.engine.entities.length;r>o;o++){var h=this.engine.entities[o];if(h!==this&&h.owner!==this&&h.position){var a=helpers.distance(this.position,h.position);t>a&&(t=a,this.nearestEntity=h),h.type==="star"&&h.colorIndex!==this.colorIndex&&i>a&&(i=a,n=h),(h.type==="player"||h.type==="computer")&&(s=h)}}if(this.position&&this.nearestEntity&&50>t||this.evadingTime>0){var l=this.nearestEntity.position.x-this.position.x,u=this.nearestEntity.position.y-this.position.y;this.targetVector={y:0>u?1:1,x:0>l?1:1},this.evadingTime||(this.evadingTime=3),this.evadingTime--,this.mousePosition=helpers.rotate(this.position,this.nearestEntity.position,-5),this.evading=!0}if(this.target=null,s&&!s.finished&&(this.target=s),this.target||(this.target=n),this.target){var l=this.target.position.x-this.position.x,u=this.target.position.y-this.position.y;if(this.targetVector={y:0>u?-1:1,x:0>l?-1:1},!this.evading){var p=u>=10||-10>=u,c=l>=80||-80>=l,d=60>l&&l>-60;this.mousePosition={x:this.position.x+this.targetVector.x*(c?100:d?-100:0),y:this.position.y+this.targetVector.y*(p?100:0)}}this.position.x==e.x&&this.direction!=this.targetVector.x&&(this.direction=this.targetVector.x),this.shoot=40>u&&u>-40&&this.direction==this.targetVector.x}return{mousePosition:this.mousePosition,shoot:this.shoot}},typeof require!="undefined")var helpers=require("./../helpers").helpers,engine=require("./../engine").engine;engine.ai.ufo=function(){for(var e=this.position,t=1/0,i=null,n=1/0,s=null,o=!1,r=0;this.engine.entities.length>r;r++)if(this.engine.entities[r]!=this&&this.engine.entities[r].owner!=this&&this.engine.entities[r].position){var h=helpers.distance(this.position,this.engine.entities[r].position);t>h&&(t=h,i=this.engine.entities[r]),this.engine.entities[r].type=="star"&&this.engine.entities[r].colorIndex!=this.colorIndex&&n>h&&(n=h,s=this.engine.entities[r])}if(i&&3>t){var a=i.position.x-this.position.x,l=i.position.y-this.position.y,u={y:0>l?1:-1,x:0>a?1:-1};this.position={x:this.position.x+u.x*this.speed,y:this.position.y+u.y*this.speed},o=!0}var p=null;if(p||(p=s),p){var a=p.position.x-this.position.x,l=p.position.y-this.position.y,u={y:0>l?-1:1,x:0>a?-1:1};if(!o){var c=l>=10||-10>=l,d=a>=80||-80>=a,g=60>a&&a>-60;this.position={x:this.position.x+u.x*(d?this.speed:g?-this.speed:0),y:this.position.y+u.y*(c?this.speed:0)}}this.position.x==e.x&&this.direction!=u.x&&(this.direction=u.x),shoot=40>l&&l>-40&&this.direction==u.x}return{mousePosition:this.mousePosition,shoot:this.shoot}},engine.rendering.classic=function(e){if(this.classicRenderer||(this.classicRenderer=new engine.rendering.classic.renderer({engine:this})),this.classicRenderer.suspend(e),!this.classicRenderer.suspended&&(this.classicRenderer.context.fillStyle=this.canvasColor,this.classicRenderer.context.fillRect(0,0,window.innerWidth,window.innerHeight),this.mode=="standalone"||this.mode=="client")){for(var t=[],i=0,n=this.entities.length;n>i;i++){var s=this.entities[i];s.topMost?t.push(s):this.classicRenderer.renderEntity(s)}for(var i=0,n=t.length;n>i;i++)this.classicRenderer.renderEntity(t[i]);for(var i=0,n=this.controllers.length;n>i;i++){var o=this.controllers[i];o.render&&o.render(this.classicRenderer.context)}}},engine.rendering.classic.renderer=function(){var e=function(e){helpers.apply(e,this),this.canvas=document.createElement("canvas"),document.body.appendChild(this.canvas),this.canvas.style.position="absolute",this.canvas.style.backgroundColor="#000",this.canvas.onmousedown=this.onmousedown.bind(this),this.canvas.onmouseup=this.onmouseup.bind(this),window.onmousemove=this.onmousemove.bind(this),window.onresize=this.resize.bind(this),this.resize()};return e.prototype.suspend=function(e){this.suspended&&!e?(this.canvas.style.display="block",window.onmousemove=this.onmousemove.bind(this),window.onresize=this.resize.bind(this),this.resize()):!this.suspended&&e&&(this.canvas.style.display="none"),this.suspended=e},e.prototype.resize=function(){this.canvas.style.top="0px",this.canvas.style.left="0px",this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight;var e=this.canvas.width/this.engine.width,t=this.canvas.height/this.engine.height;this.scale=t>e?e:t,this.offsetTop=Math.ceil((this.canvas.height-this.engine.height*this.scale)/2),this.engine.touchController.touchable&&this.offsetTop>40&&(this.offsetTop=40),this.offsetLeft=Math.ceil((this.canvas.width-this.engine.width*this.scale)/2),this.context=this.canvas.getContext("2d");for(var i=0,n=this.engine.controllers.length;n>i;i++){var s=this.engine.controllers[i];s.render&&s.resize()}},e.prototype.notify=function(e,t){if(t&&e)for(var i=0,n=t.length;n>i;i++)t[i][e]&&t[i][e](t[i],t[i])},e.prototype.onmousemove=function(e){if(!this.suspended){var t=e||window.event,i={x:(t.clientX-this.offsetLeft)/this.scale,y:(t.clientY-this.offsetTop)/this.scale};this.engine.touchController.touchable||(this.engine.mousePosition=i,this.engine.absoluteController=!0);var n=this.engine.entities;this.mouseEntities=[];for(var s=0,o=n.length;o>s;s++){var r=n[s];r.mousePlane&&(r.mousePosition=i,this.mouseEntities.push(r))}this.notify("onmousemove",this.mouseEntities)}},e.prototype.onmousedown=function(){this.suspended||(this.engine.touchController.touchable||(this.engine.buttonDown=!0),this.notify("onmousedown",this.mouseEntities))},e.prototype.onmouseup=function(){this.suspended||(this.engine.touchController.touchable||(this.engine.buttonDown=!1),this.notify("onmouseup",this.mouseEntities))},e.prototype.renderEntity=function(e){if(!this.suspended&&(e.render&&e.render(),e.classicModel&&this.drawRects({x:e.position.x,y:e.position.y},e.classicModel,e.color,!0),e.texts))for(var t=0,i=e.texts.length;i>t;t++){var n=e.texts[t];this.context.font=Math.ceil(50*this.scale)+"px CBM64",this.context.fillStyle=n.color,this.context.fillText(n.text,Math.ceil(n.position.x*this.scale)+this.offsetLeft,Math.ceil(n.position.y*this.scale)+this.offsetTop)}},e.prototype.drawRects=function(e,t,i,n){if(t)for(var s=0,o=t.length;o>s;s++)this.drawRect(e,t[s],i,n)},e.prototype.drawRect=function(e,t,i,n){n?(this.context.fillStyle=i,this.context.fillRect((t.x+e.x)*this.scale+this.offsetLeft,(t.y+e.y)*this.scale+this.offsetTop,t.w*this.scale,(t.h+2)*this.scale)):(this.context.strokeStyle=i,this.context.strokeRect((t.x+e.x)*this.scale,(t.y+e.y)*this.scale,t.w*this.scale,t.h*this.scale))},e}();var touchController=function(e){e&&e.engine&&(this.engine=e.engine),this.resize(),this.leftTouchID=-1,this.rightTouchID=-1,this.secondRightTouchID=-1,this.leftTouchPos={x:0,y:0},this.leftTouchStartPos={x:0,y:0},this.leftVector={x:0,y:0},this.touchable="createTouch"in document,this.touches=[],this.touchable&&(window.addEventListener("touchstart",this.onTouchStart.bind(this),!1),window.addEventListener("touchmove",this.onTouchMove.bind(this),!1),window.addEventListener("touchend",this.onTouchEnd.bind(this),!1))};touchController.prototype.resize=function(){this.halfWidth=window.innerWidth/2,this.halfHeight=window.innerHeight/2},touchController.prototype.render=function(e){if(this.touchable){for(var t="rgba(255,255,255,0.18)",i=!1,n=!1,s=0,o=this.touches.length;o>s;s++){var r=this.touches[s];r.identifier===this.leftTouchID?(this.drawCircle(e,t,6,this.leftTouchPos,40),this.drawCircle(e,t,2,this.leftTouchStartPos,60),this.drawCircle(e,t,2,this.leftTouchStartPos,40),i=!0):(this.drawCircle(e,t,6,{x:r.clientX,y:r.clientY},50),n=!0)}if(!i){var h={x:70,y:window.innerHeight-70};this.drawCircle(e,t,6,h,40),this.drawCircle(e,t,2,h,60)}n||this.drawCircle(e,t,6,{x:window.innerWidth-70,y:window.innerHeight-70},50),this.drawCircle(e,t,3,{x:window.innerWidth-20,y:40},15),this.drawLine(e,t,3,{x:window.innerWidth-27,y:35},{x:window.innerWidth-13,y:35}),this.drawLine(e,t,3,{x:window.innerWidth-27,y:40},{x:window.innerWidth-13,y:40}),this.drawLine(e,t,3,{x:window.innerWidth-27,y:45},{x:window.innerWidth-13,y:45})}},touchController.prototype.inMenuArea=function(e,t){return e>window.innerWidth-45&&55>t},touchController.prototype.drawLine=function(e,t,i,n,s){e.beginPath(),e.strokeStyle=t,e.lineWidth=i,e.moveTo(n.x,n.y),e.lineTo(s.x,s.y),e.closePath(),e.stroke()},touchController.prototype.drawCircle=function(e,t,i,n,s){e.beginPath(),e.strokeStyle=t,e.lineWidth=i,e.arc(n.x,n.y,s,0,Math.PI*2,!0),e.stroke()},touchController.prototype.onTouchStart=function(e){for(var t=0,i=e.changedTouches.length;i>t;t++){var n=e.changedTouches[t];0>this.leftTouchID&&this.halfWidth>n.clientX?(this.leftTouchID=n.identifier,this.leftTouchStartPos={x:n.clientX,y:n.clientY},this.leftTouchPos={x:n.clientX,y:n.clientY},this.leftVector={x:0,y:0}):this.inMenuArea(n.clientX,n.clientY)?(this.secondRightTouchID=n.identifier,this.engine.rightButtonDown=!0):0>this.rightTouchID&&(this.rightTouchID=n.identifier,this.engine.buttonDown=!0)}this.touches=e.touches},touchController.prototype.onTouchMove=function(e){e.preventDefault();for(var t=0,i=e.changedTouches.length;i>t;t++){var n=e.changedTouches[t];if(this.leftTouchID===n.identifier){this.leftTouchPos={x:n.clientX,y:n.clientY},this.leftVector={x:n.clientX-this.leftTouchStartPos.x,y:n.clientY-this.leftTouchStartPos.y},this.engine.mousePosition={x:Math.floor(this.leftVector.x/5),y:Math.floor(this.leftVector.y/5)},this.engine.absoluteController=!1;break}}this.touches=e.touches},touchController.prototype.onTouchEnd=function(e){this.touches=e.touches;for(var t=0,i=e.changedTouches.length;i>t;t++){var n=e.changedTouches[t];this.leftTouchID===n.identifier?(this.leftTouchID=-1,this.leftVector={x:0,y:0},this.engine.mousePosition=this.leftVector,this.engine.absoluteController=!1):this.rightTouchID===n.identifier?(this.rightTouchID=-1,this.engine.buttonDown=!1):this.secondRightTouchID===n.identifier&&this.inMenuArea(n.clientX,n.clientY)&&(this.secondRightTouchID=-1,this.engine.rightButtonDown=!1)}};var mouseController=function(e){e&&e.engine&&(this.engine=e.engine),this.buttonDown=!1,this.enabled=!1,this.controllerType="absolute",this.mousePosition={x:0,y:0},this.touchable="createTouch"in document,this.touchable||(this.enabled=!0,document.addEventListener?(document.addEventListener("mousedown",this.down.bind(this),!1),document.addEventListener("mousemove",this.move.bind(this),!1),document.addEventListener("mouseup",this.up.bind(this),!1)):document.attachEvent?(document.attachEvent("onmousedown",this.down.bind(this)),document.attachEvent("onmousemove",this.move.bind(this)),document.attachEvent("onmouseup",this.up.bind(this))):document.onmousedown||document.onmouseup||(document.onmousedown=this.down.bind(this),document.onmousemove=this.move.bind(this),document.onmouseup=this.up.bind(this)))};mouseController.prototype.down=function(){this.buttonDown=!0},mouseController.prototype.move=function(e){this.mousePosition={x:e.clientX,y:e.clientY}},mouseController.prototype.up=function(){this.buttonDown=!1}